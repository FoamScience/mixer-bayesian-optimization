# Bayesian Optimization of an annular thermal mixer with OpenFOAM and foamBO

A WIP demonstration (PoC) repository on how to use `foamBO` to run Bayesian Optimization
algorithms on OpenFOAM cases.

## Requirements and running

Take a look at `config.yaml` for the parameter set and objective functions.

```bash
pip install -r requirements.txt # is a good idea
# You also need to have ParaView 5.10 or later (for pvpython)
# To start the optimization study:
foamBO
# If you want to monitor trials as they complete;
# by rendering results, set:
export IMGBB_API_KEY=<your-api-key-from-imgbb.com>
foamDash
```

> TODO: create and document apptainer containers 

## Q&As

### 1. How many case runs do we need to reach a conclusion?

#### 1.1 Trials-to-"convergence" for the Bayesian optimization algorithm

> TODO: formulate an opinion

#### 1.2 Parallel trials vs total trial number trade-off 

> TODO: formulate an opinion

#### 1.3 How sensitive the convergence time is to adding a continuous-value parameter to the search space

> TODO: formulate an opinion

## Necessary changes to the OpenFOAM case

> [!TIP]
> Git shows more accurate changes:
> ```bash
> treecommit=$(git log --format='%H' --author=Elwardi --reverse -- annularThermalMixer/ | head -1)
> git diff $treecommit..HEAD -M -- annularThermalMixer
> ```
> But this section will motivate the important ones.


### 1. Geometry generation

- All original OBJ geometries are converted to (non-compressed) STL format.
- `shaft.stl`, `statorBlades.stl` and `rotorBlades.stl` are now dynamically
  generated by `geometry/generate.py` Python script, based on `constant/cadDict` settings.
- `Allrun` is modified to run `geometry/generate.py` instead of copying original surfaces.

I still have some concerns:

- `snappyHexMesh` is kept as the mesh generator, and it doesn't keep a constant max
  cell size if the dimensions of the domain change (eg. How far the AMI patch is from the shaft).
  So, any optimization study may be biased towards specific sets of dimensions. `cfMesh`
  would do better.

### 2. Parallel execution

- A single serial run of the case takes around 20 mins to simulate 1 sec.
  Overall mesh resolution has been lowered from the base case.
- The case is parallelized for 4 processors, anticipating parallel runs of the case
  by the optimization algorithm. Trial execution time becomes 10 mins with 4 procs.

### 3. Objectives computation

The following objective functions are computed using `obj*.sh` scripts for convenience.
Scalar values to represent the following objectives are chosen so the minimization of
the scalar values results in better objectives.

1. Blade durability is estimated through erosion prediction which is represented by
   wall shear stress, raised to some power (2, or 3); Total surface area of patch faces with more than 70% 
   of the value-range of "the shear stress squared" is used as an indication of possible erosion regions.
1. Mixing quality is estimated through Coefficient of variation (CoV) of component concentrations (alpha fields).
    - This is a two-phase computation, so there is only one alpha field
1. Power consumption is computed through pressure and shear stress fields on the impeller.
    - Torque is computed through `propellerInfo` function object.
    - Power consumption = torque x blade rotational speed
